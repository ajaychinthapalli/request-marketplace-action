name: Initialize Marketplace Action Request

on:
  issues:
    types: [opened, edited]

jobs:
  initialize-request:
    runs-on: self-hosted
    steps:
    - name: Get JSON Data out of Issue Request
      uses: peter-murray/issue-body-parser-action@v1
      id: issue_body_parser_request
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        issue_id: ${{ github.event.issue.number }}
        payload_marker: request
    - name: Check out scripts
      uses: actions/checkout@v2

    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: '14'
        check-latest: true
    - name: Install dependencies
      run: |
        cd .github/scripts
        npm install
    - name: Dump steps context
      run: echo '${{ toJSON(steps) }}'
    - name: Create the repo actions-approved/ ${{ fromJson(steps.issue_body_parser_request.outputs.payload).repo }}_${{ fromJson(steps.issue_body_parser_request.outputs.payload).ref }} on GitHub Enterprise Server
      uses: actions/github-script@main
      with:
        debug: true
        script: |
          const options = { token: '${{ secrets.TOKEN }}', baseUrl: '${{ github.api_url }}' };
          const payload = ${{ steps.issue_body_parser_request.outputs.payload }}
          await require('./.github/scripts/initialize-request.js')({github, context, payload, options});
    - name: Check out requested action repo ${{ fromJson(steps.issue_body_parser_request.outputs.payload).owner }}/${{ fromJson(steps.issue_body_parser_request.outputs.payload).repo }}_${{ fromJson(steps.issue_body_parser_request.outputs.payload).ref }}
      run: |
        git clone https://github.com/'${{ fromJson(steps.issue_body_parser_request.outputs.payload).owner }}/${{ fromJson(steps.issue_body_parser_request.outputs.payload).repo }}' requested-action
    - name: Show the directory
      run: ls -l requested-action
    - name: Push requested action to private repo in actions-approved org on GitHub Enterprise Server
      run: |
        cd requested-action
        git config user.email '${{ secrets.GITHUB_EMAIL }}'
        git config user.name '${{ secrets.GITHUB_USERNAME }}'
        if [`git checkout main`]; then
          git branch -m main-old
        fi
        git checkout ${{ fromJson(steps.issue_body_parser_request.outputs.payload).ref }}
        git switch -c ${{ fromJson(steps.issue_body_parser_request.outputs.payload).ref }}-branch
        git branch -m main
        git remote add origin2 ${{ github.server_url }}/actions-approved/${{ fromJson(steps.issue_body_parser_request.outputs.payload).repo }}_${{ fromJson(steps.issue_body_parser_request.outputs.payload).ref }}.git
        git push -u origin2 main
        git push -u origin2 ${{ fromJson(steps.issue_body_parser_request.outputs.payload).ref }}
        