name: Approve or Deny Marketplace Action Request

on:
  issue_comment:
    types: [created]

jobs:
  approve-or-deny-request:
    runs-on: self-hosted
    steps:
    - name: Get JSON Data out of Issue Request
      uses: peter-murray/issue-body-parser-action@v1
      id: issue_body_parser_request
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        issue_id: ${{ github.event.issue.number }}
        payload_marker: request
    - name: Check out scripts
      uses: actions/checkout@v2
    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: '14'
        check-latest: true
    - name: Install dependencies
      run: |
        cd .github/scripts
        npm install
    - name: Lookup the latest release of ${{ fromJson(steps.issue_body_parser_request.outputs.payload).owner }}/${{ fromJson(steps.issue_body_parser_request.outputs.payload).repo }}
      id: lookup_latest_release
      run: |
        export URL=${{steps.parser.outputs.url}}
        export OWNER=${${URL#"https://github.com/"}%/*}
        export REPO=${${URL#"https://github.com/"}#*/}
        export LATEST=`curl https://api.github.com/repos/$OWNER/$REPO/releases/latest | jq -r .name`
        echo "LATEST RELEASE: $LATEST"
        echo "::set-output name=owner::$OWNER"
        echo "::set-output name=repo::$REPO"
        echo "::set-output name=latest_release::$LATEST"
    - name: Approve or deny request
      uses: actions/github-script@main
      with:
        debug: true
        script: |
          const options = { token: '${{ secrets.TOKEN }}', adminOpsOrg: '${{ secrets.ADMIN_OPS_ORG }}', actionsApprovedOrg: '${{ secrets.ACTIONS_APPROVED_ORG }}', actionsApproverTeam: '${{ secrets.ACTIONS_APPROVERS_TEAM }}', baseUrl: '${{ github.api_url }}', owner: '${{ steps.lookup_latest_release.outputs.owner }}', repo: '${{ steps.lookup_latest_release.outputs.repo }}', latestRelease: '${{ steps.lookup_latest_release.outputs.latest_release }}' };
          await require('./.github/scripts/approve-or-deny-request.js')({github, context, options});
